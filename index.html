<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>DevHubConnect - Premium Automation Templates</title>
    <meta name="description" content="Discover and purchase premium automation workflow templates. Save development time with our curated collection." />
    <meta name="author" content="DevHubConnect" />

    <!-- Open Graph -->
    <meta property="og:title" content="DevHubConnect - Premium Automation Templates" />
    <meta property="og:description" content="Discover and purchase premium automation workflow templates. Save development time with our curated collection." />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />
    <meta property="og:url" content="https://devhubconnect.com" />

    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@devhubconnect" />
    <meta name="twitter:title" content="DevHubConnect - Premium Automation Templates" />
    <meta name="twitter:description" content="Discover and purchase premium automation workflow templates. Save development time with our curated collection." />
    <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <!-- Favicon (Expanded Support) -->
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">

    <!-- Preconnect to improve image CDN load time -->
    <link rel="preconnect" href="https://lovable.dev" crossorigin />
    <link rel="preconnect" href="https://i.ibb.co" crossorigin />

    <!-- Optional: Boost lazy loading with low fetch priority (no script required) -->
    <meta name="fetchpriority" content="low" />

    <!-- Auth Checker Script -->
    <script>
      // Frontend Authentication Checker - Inline for immediate execution
      class AuthChecker {
        constructor() {
          this.user = null;
          this.isAuthenticated = false;
          this.checkingAuth = false;
        }

        async checkAuthStatus() {
          if (this.checkingAuth) return;
          this.checkingAuth = true;

          try {
            console.log('üîç Checking authentication status...');
            
            // Try the session endpoint first
            const response = await fetch('/api/auth/profile/session', {
              method: 'GET',
              credentials: 'include', // Important: include cookies
              headers: {
                'Content-Type': 'application/json'
              }
            });

            if (response.ok) {
              const data = await response.json();
              console.log('‚úÖ User authenticated:', data.user.username);
              this.user = data.user;
              this.isAuthenticated = true;
              this.updateUI();
              return true;
            } else {
              console.log('‚ùå User not authenticated');
              this.user = null;
              this.isAuthenticated = false;
              this.updateUI();
              return false;
            }
          } catch (error) {
            console.error('üö® Auth check error:', error);
            this.user = null;
            this.isAuthenticated = false;
            this.updateUI();
            return false;
          } finally {
            this.checkingAuth = false;
          }
        }

        updateUI() {
          // Update the sign in button or user info display
          const signInButton = document.querySelector('[data-auth="sign-in"]');
          const userInfo = document.querySelector('[data-auth="user-info"]');
          const githubButton = document.querySelector('[data-auth="github"]');
          
          if (this.isAuthenticated && this.user) {
            // Hide sign in button, show user info
            if (signInButton) signInButton.style.display = 'none';
            if (githubButton) githubButton.style.display = 'none';
            if (userInfo) {
              userInfo.style.display = 'block';
              userInfo.innerHTML = `
                <div class="flex items-center space-x-2">
                  <img src="${this.user.avatar_url}" alt="${this.user.username}" class="w-8 h-8 rounded-full">
                  <span>Welcome, ${this.user.username}!</span>
                  <button onclick="authChecker.logout()" class="text-red-600 hover:text-red-800">Logout</button>
                </div>
              `;
            }
          } else {
            // Show sign in button, hide user info
            if (signInButton) signInButton.style.display = 'block';
            if (githubButton) githubButton.style.display = 'block';
            if (userInfo) userInfo.style.display = 'none';
          }
        }

        async logout() {
          try {
            const response = await fetch('/api/auth/logout', {
              method: 'POST',
              credentials: 'include'
            });
            
            if (response.ok) {
              console.log('‚úÖ Logged out successfully');
              this.user = null;
              this.isAuthenticated = false;
              this.updateUI();
              // Optionally redirect to home
              window.location.href = '/';
            }
          } catch (error) {
            console.error('üö® Logout error:', error);
          }
        }

        handleOAuthCallback() {
          // Check if we're coming back from OAuth
          const urlParams = new URLSearchParams(window.location.search);
          const authStatus = urlParams.get('auth');
          
          if (authStatus === 'success') {
            console.log('üéâ OAuth success detected! Checking session...');
            // Clean the URL
            window.history.replaceState({}, document.title, window.location.pathname);
            // Check auth status after a brief delay to ensure session is set
            setTimeout(() => this.checkAuthStatus(), 1000);
          } else if (authStatus === 'error') {
            console.log('‚ùå OAuth error detected');
            alert('Authentication failed. Please try again.');
            // Clean the URL
            window.history.replaceState({}, document.title, window.location.pathname);
          }
        }

        initGitHubLogin() {
          // Add click handler to GitHub login button
          const githubButton = document.querySelector('[data-auth="github"]');
          if (githubButton) {
            githubButton.addEventListener('click', (e) => {
              e.preventDefault();
              console.log('üîÑ Initiating GitHub OAuth...');
              window.location.href = '/api/auth/github';
            });
          }
        }

        init() {
          console.log('üöÄ Initializing Auth Checker...');
          
          // Handle OAuth callback
          this.handleOAuthCallback();
          
          // Check initial auth status
          this.checkAuthStatus();
          
          // Initialize GitHub login (retry if button not found)
          const tryInitGitHub = () => {
            const githubButton = document.querySelector('[data-auth="github"]');
            if (githubButton) {
              this.initGitHubLogin();
            } else {
              // Retry after 1 second if button not found
              setTimeout(tryInitGitHub, 1000);
            }
          };
          tryInitGitHub();
          
          // Check auth status periodically (every 5 minutes)
          setInterval(() => this.checkAuthStatus(), 5 * 60 * 1000);
        }
      }

      // Create global instance
      const authChecker = new AuthChecker();

      // Auto-initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => authChecker.init());
      } else {
        authChecker.init();
      }

      // Export for use in other scripts
      window.authChecker = authChecker;
    </script>
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx" defer></script>
  </body>
</html>